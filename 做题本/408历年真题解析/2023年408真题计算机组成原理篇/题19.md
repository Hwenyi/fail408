---
publish: true
tags: 
aliases: 
finished: true
title: 题19
created: "2024-11-21 07:30"
updated: "2024-11-21 07:40"
---
## 题19
### 题目
> [!question]+
> 在采用 “取指、译码 / 取数、执行、访存、写回” 5 段流水线的 RISC 处理器中，执行如下指令序列（第一列为指令序号），其中 s0、s1、s2、s3 和 t2 表示寄存器编号。
> 
> ```cpp
> I1     add s2, s1, s0   // R[s2] ← R[s1] + R[s0]
> I2     load s3, 0(s2)   // R[s3] ← M[R[s2] + 0]
> I3     beq t2, s3, L1   // if R[t2] = R[s3] jump to L1
> I4     addi t2, t2, 20  // R[t2] ← R[t2] + 20
> I5 L1:
> ```
> 
> 若采用转发（旁路）技术处理数据冒险，采用硬件阻塞方式处理控制冒险，则在 I1~I4 执行过程中，发生流水线阻塞的指令有（ ）。
> 
> A. 仅 I3
> 
> B. 仅 I2、I4
> 
> C. 仅 I3、I4
> 
> D. 仅 I2、I3、I4
### 解
> [!done]+
> I2 和 I1 之间存在数据冒险，属于**写后读数据冒险（read after write Data Hazard, RAW Data Hazard）**：读取某数据操作必须在写入该数据操作之后执行，否则可能产生错误。I1 在 WB 段才将新值写回寄存器 R[s2]，但 I2 的 EX 段就要读 R[s2] 以计算访存的有效地址，I1 在 EX 段结束时就已生成 R[s2] 的新值，被存放在 EX→M 流水段寄存器中，采用转发技术后，可以直接从该流水段寄存器中取出数据送到 ALU 输入端，这样 I2 执行时 ALU 用的是 R[s2] 的新值，解决了 I1 和 I2 的数据冒的险。
> 
> I3 和 I2 之间存在数据冒险，属于**装入 - 使用数据冒险（load-use Data Hazard）**：LOAD 指令和随后使用 LOAD 指令所加载数据的后续指令之间存在的依赖关系，即使用某数据操作必须在装入该数据之后执行，否则可能产生错误。仅用转发线路无法解决 I2 和 I3 之间的数据相关问题，需要用转发技术结合装入 - 使用阻塞解决。原因在于 I2 的功能是从内存中取数，只有在 M 段结束时才能从主存中得到 R[s3] 的新值，即先装入后使用，但 I3 的 EX 段就要用到 R[s3]，I3 需要阻塞 1 个时钟周期，等到 I2 的 M 段结束之后，从 I2 的 M→WB 流水段寄存器中取到 R[s3] 的新值。
> 
> 常考的数据冒险有：**写后读（read after write, RAW）**数据冒险、**写后写（write after write, WAW）**数据冒险、**读后写（write after read, WRA）**数据冒险、**装入 - 使用（load-use）**数据冒险等。
> 
> **在按序发射，按序流动的流水线中，可能出现写后读（RAW）数据冒险和装入 - 使用（load-use）数据冒险。**
> 
> I4 和 I3 之间存在控制冒险，beq 指令在 EX 段计算转移目的地址，在 M 段确定是否将 PC 值更新为转移目的地址。因此在 I4 和 I3 日之间需要进行阻塞，I4 的 IF 段要在 I3 的 M 段结束之后才能开始执行。I4 的执行需要被阻塞 3 个时钟周期。
> 
> 采用硬件阻塞方式进行阻塞，指令的执行过程如下图所示。
> 
> ![](https://pic2.zhimg.com/v2-3ae20fa2d9d98c93bb4b815bca9b0cd1_r.jpg)
> 
> 本题选 C。
> 
> **_拓展_**
> 
> 数据冒险的解决方法
> 
> 1. 硬件阻塞（stall）。
> 2. 软件插入 NOP 指令。
> 3. 合理实现寄存器组的读 / 写操作（不能解决所有数据冒险）
> 4. 转发（Forwarding 或 Bypassing 旁路）技术。
> 5. 编译优化：调整指令顺序（不能解决所有数据冒险）。
> 
> 关于数据冒险，推荐阅读[处理器设计 Data Hazard 的含义与解决方法](https://zhuanlan.zhihu.com/p/610683510)。
> 
> 关于指令流水线，推荐学习袁春风的《计算机组成与系统结构》或[《计算机组成原理》](https://www.bilibili.com/video/BV1rJ411U7EC/)课程。