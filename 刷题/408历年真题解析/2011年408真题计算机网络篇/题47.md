---
publish: true
tags: 
aliases: 
finished: true
title: 题47
created: "2024-11-21 06:41"
updated: "2024-11-21 07:40"
---
## 题47
### 题目
> [!question]+
> （9 分）
> 
> 某主机的 MAC 地址为 00-15-C5-C1-5E-28，IP 地址为 10.2.128.100（私有地址）。题 47-a 图是网络拓扑，题 47-b 图是该主机进行 Web 请求的 1 个以太网数据帧前 80 个字节的十六进制及 ASCII 码内容。
> 
> ![](https://pica.zhimg.com/v2-b8d4528302e134ba6fa9c8cf1d079972_r.jpg)
> 
> ![](https://pica.zhimg.com/v2-852b8fe615ced18687d0e9423af27958_r.jpg)
> 
> 请参考图中的数据回答以下问题。
> 
> (1) Web 服务器的 IP 地址是什么？该主机的默认网关的 MAC 地址是什么？
> 
> (2) 该主机在构造题 47-b 图的数据帧时，使用什么协议确定目的 MAC 地址？封装该协议请求报文的以太网帧的目的 MAC 地址是什么？
> 
> (3) 假设 HTTP/1.1 协议以持续的非流水线方式工作，一次请求 - 响应时间为 RTT，rfc.html 页面引用了 5 个 JPEG 小图像，则从发出题 47-b 图中的 Web 请求开始到浏览器收到全部内容为止，需要多少个 RTT？
> 
> (4) 该帧所封装的 IP 分组经过路由器 R 转发时，需修改 IP 分组头中的哪些字段？
> 
> 注意：以太网数据帧结构和 IP 分组头结构分别如题 47-c 图、题 47-d 图所示。
> 
> ![](https://pica.zhimg.com/v2-125db56e870d372321d294104d3ac74a_r.jpg)
### 解
> [!done]+
> 根据以太网数据帧结构和 IP 分组头结构，将以太网数据帧中的各个字段标出。如下图所示。
> 
> ![](https://picx.zhimg.com/v2-1cb228ebe9640d9a65be280eafe5f0e7_r.jpg)
> 
> 完整分析所有 IP 字段如下：
> 
> **版本**：占 4 bit，因为是 IPv4，对应十六进制值为 4 H。本题中为 4 H。
> 
> **头部长度**：占 4 bit，表示 IP 数据报首部长度，取值以 4 B 为单位，最小长度 20 B，对应十六进制值为 5 H。本题中为 5 H。
> 
> **服务类型**：占 8 bit，用于表示数据包的优先级，不同数值可提供不同等级的服务质量，一般情况下不使用，默认值为 0，对应十六进制值为 00 H。本题中为 00 H。
> 
> **总长度**：占 16 bit，IP 数据报总长度 = 头部长度 + 数据载荷长度，取值以 1 B 为单位，最大传送单元 MTU = 1500 B，总长度不超过 MTU。本题中为 01ef H。即 IP 数据报总长度为 495 B。
> 
> **标识**：占 16 bit，用于唯一标识主机发送的每一个 IP 包，每发送一个包其值就会加 1。当 IPv4 数据报长度超过 MTU 时，无法封装成帧，必须进行分片，属于同一个数据报的各分片有相同的标识。本题中为 113b H。
> 
> **标志**：占 3 bit，从左到右依次为
> 
> - 保留位：占 1 bit，为 0。
> - DF (Don’t Fragment)：占 1 bit，1 表示不允许分片，0 表示允许分片。
> - MF (More Fragment)：占 1 bit，1 表示后面还有分片，0 表示这是最后一个分片。
> 
> **片偏移**：占 13 bit，取值以 8 B 为单位，指出分片数据的数据载荷部分偏移其原数据报位置有多少个单位。
> 
> 本题中，标志和片偏移拼接为 4000 H，二进制为 0100 0000 0000 0000 B，标志二进制为 010 B，其中保留位为 0，DF 为 1，表示不允许分片，MF 为 0，表示这是最后一个分片。片偏移二进制为 0 0000 0000 0000 B，即为 0。因为没有分片，所以不会产生片偏移。
> 
> **生存时间 (TTL)**：占 8 bit，设置数据包可以经过的路由器数目。每经过一个路由器，TTL 值就会减 1，当该字段值为 0 时，数据包将被丢弃。本题中为 80 H。
> 
> **协议**：占 8 bit，此分组数据提供给哪个传输层协议。常用 IP 协议号对应的上层协议如下：
> 
> <table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>上层协议</th><th>协议号</th><th>协议号（十六进制表示）</th></tr><tr><td>ICMP</td><td>1</td><td>01</td></tr><tr><td>IGMP</td><td>2</td><td>02</td></tr><tr><td>TCP</td><td>6</td><td>06</td></tr><tr><td>UDP</td><td>17</td><td>11</td></tr><tr><td>IPv6</td><td>41</td><td>29</td></tr><tr><td>OSPF</td><td>89</td><td>59</td></tr></tbody></table>
> 
> 本题中为 06 H。上层协议为 TCP 协议，HTTP 协议是基于 TCP 协议的。
> 
> **头部校验和**：占 16 bit，用于检验 IP 头部是否损坏，数据的可靠性是由 TCP 保证的。本题中为 ba9d H。
> 
> **源 IP 地址**：占 32 bit，数据包的源节点的 IP 地址。本题中为 0a028064 H。点分十进制格式为 10.2.128.100。
> 
> **目的 IP 地址**：占 32 bit，数据包的目的点的 IP 地址。本题中为 40aa6220 H。点分十进制格式为 64.170.98.32。
> 
> (1) 第一问。因为题 47-b 图是该主机进行 Web 请求的以太网数据帧内容，所以 Web 服务器的 IP 地址位于 IP 头部的目的 IP 地址字段，16 进制格式为 40 aa 62 20，转化为点分十进制格式为 64.170.98.32。
> 
> 第二问。根据网络拓扑图可知，该主机的默认网关是路由器 R，分析数据链路，主机会将 Web 请求发送给默认网关，再由默认网关将 Web 请求转发给 Web 服务器。所以以太网帧的目的 MAC 地址 00-21-27-21-51-ee 即为该主机的默认网关的 MAC 地址。
> 
> (2) 已知目的 IP 地址，但不知道目的 MAC 地址，需要使用 [[ARP地址解析协议|ARP]] 协议确定目的 [[MAC地址]]。因为 ARP 协议请求报文需要进行广播，最后路由器返回 ARP 单播响应得到目的 MAC 地址。所以封装 ARP 协议请求报文的以太网数据帧的目的 MAC 地址是 ff-ff-ff-ff-ff-ff。
> 
> (3) HTTP/1.1 协议与 HTTP/1.0 相比有了一些重要的改进，其中包括持续连接的引入。持续连接允许客户端和服务器之间的单个 TCP 连接传输多个 HTTP 请求和响应，而无需为每个请求 / 响应对创建新的连接。这样可以减少连接的建立和关闭所带来的开销，并且可以更有效地利用网络资源。在 HTTP/1.1 中，默认情况下使用持续连接，除非在请求头中显式指定 Connection: close 来关闭连接。这与 HTTP/1.0 不同，后者在每个请求 / 响应后都会关闭连接。
> 
> 非流水线方式指每一个请求需要等待其对应的响应返回之后，才能发送下一个请求。换句话说，当使用非流水线方式时，客户端发送一个请求后需要等待服务器返回相应的响应后才能发送下一个请求，而不会同时发送多个请求。
> 
> HTTP 是基于 TCP 的应用层协议。
> 
> TCP 头结构如下图所示：
> 
> ![](https://pic3.zhimg.com/v2-95a47436b81119cb30167425a437f862_r.jpg)
> 
> 根据以太网数据帧结构、IP 分组头和 TCP 头的结构，将以太网数据帧中的各个字段标出。如下图所示。
> 
> ![](https://pic2.zhimg.com/v2-c10a0ca965bcc55ac37b88dcb3360301_r.jpg)
> 
> 完整分析 TCP 段头字段如下：
> 
> **源端口**：占 16 bit，发送端的应用程序端口号。
> 
> **目标端口**：占 16 bit，接收端的应用程序端口号。
> 
> **序号 (seq)**：占 32 bit，TCP 报文段数据载荷第一个字节的序号，以确保接收方能够按正确的顺序重新组装。
> 
> **确认号 (ack)**：占 32 bit，只有在 ACK 标志位被设置为 1 时才有效，表示接收端期望收到的下一个字节的序号。
> 
> **数据偏移**：占 4 bit，以 4 B 为单位，表示 TCP 报文段数据载荷的起始处与 TCP 报文段的起始处的距离。实际上指出了 TCP 报文段头的长度。
> 
> **保留**：占 6 bit，保留供将来使用，目前应设置为 0。
> 
> **控制位**：占 6 bit，总共 6 个标志位，每个各占 1 bit，用于指示 TCP 报文段的各种控制信息。从左到右依次为
> 
> - URG：表示紧急指针字段是否有效。
> - ACK：表示确认号字段是否有效。
> - PSH：表示接收端是否应该尽快将数据交给应用程序。
> - PST：表示是否需要重置连接。
> - SYN：在建立 TCP 连接时用来同步请求。
> - FIN：在释放 TCP 连接时用于关闭连接。
> 
> **窗口**：占 16 bit，指定发送端希望接收端为此连接分配的接收窗口大小。
> 
> **校验和**：占 16 bit，用于检测 TCP 报文段是否在传输过程中发生错误。
> 
> **紧急指针**：占 16 bit，只有在 URG 标志位被设置为 1 时才有效。指示紧急数据的边界。
> 
> TCP 建立三次握手的示意图如下：
> 
> ![](https://pic1.zhimg.com/v2-949700d8c797c1185bbb155e26efaecc_r.jpg)
> 
> 本题中，保留和控制位内容为 018 H = $\rm 0000 00\underbrace{0}_{URG}\underbrace{1}_{ACK}\underbrace{1}_{PSH}\underbrace{0}_{RST}\underbrace{0}_{SYN}\underbrace{0}_{FIN}$ B，其中 ACK = 1，SYN = 0。
> 
> 若该报文是 TCP 的第一次握手，则其中 ACK = 0，SYN = 1，所以该报文不是 TCP 的第一次握手。
> 
> 若该报文是 TCP 的第二次握手，则其中 ACK = 1，SYN = 1，所以该报文不是 TCP 的第二次握手。
> 
> 所以该报文是 TCP 的第三次握手或者 TCP 已经建立完成后发送的，因此无需考虑建立 TCP 的一个 RTT 的开销。
> 
> HTTP/1.1 协议以持续的非流水线方式工作，每个 RTT 传输一个对象，共需传输 6 个对象（1 个 html 页面引用了 5 个 JPEG 小图像），所以共需要 6 个 RTT。
> 
> (4)
> 
> 方法一：读取 IP 头总长度字段
> 
> 因为该帧中 IP 头总长度字段为 01ef H，单位字节，即 495 B，说明 IP 数据报总长度为 495 B，即以太网帧的数据载荷为 495 B，小于 MTU=1500 B，所以该帧所封装的 IP 分组经过路由器 R 转发时，不需要进行分片。
> 
> 方法二：读取 IP 头标志字段
> 
> 标志和片偏移拼接为 4000 H，即 0100 0000 0000 0000 B，标志为 010 B，其中保留位为 0，DF 为 1，表示不允许分片，MF 为 0，表示这是最后一个分片。不允许分片蕴含 IP 数据报总长度不超过 MTU，所以该帧所封装的 IP 分组经过路由器 R 转发时，不需要进行分片。
> 
> 修改 IP 分组头中的字段如下：
> 
> 源 IP 地址：由主机的 IP 地址 10.2.128.100 修改为路由器 R 连接 Internet 的接口的 IP 地址 101.12.123.15。
> 
> 生存时间 (TTL)：IP 分组每经过一个路由器，生存时间 TTL 字段的值就减 1，由 80 H 修改为 7F H。
> 
> 首部校验和：由于上述字段发生改变，因此需要重新计算首部校验和。
> 
> **_举一反三_**
> 
> 若修改本题中以太网数据帧前 80 个字节的内容如下，题 47 图 MTU = 800 B，则该帧所封装的 IP 分组经过路由器 R 转发时，需修改 IP 分组头中的哪些字段？
> 
> ![](https://pic2.zhimg.com/v2-5c3660df1ce096f4c609105873d83b4b_r.jpg)
> 
> 参考答案
> 
> 该帧总长度字段为 05 dc H，即该帧总长度为 1500 B，大于 MTU=800 B，因此该帧所封装的 IP 分组经过路由器 R 转发时需要进行分片，需要修改的字段除源 IP 地址、生存时间 (TTL) 和首部校验和之外，还有总长度、标志（除最后一个分片外，其它分片的 MF 为 1）和片偏移（除第一个分片外，设分片编号为 $1,2,...,n$ ，第 $i$ 个分片 IP 数据载荷长度为 $l_i$ ，设分片前片偏移为 $s$ ，分片后第 $i$ 个分片片偏移为 $\displaystyle{s_i=s+\sum_{j=1}^{i-1}l_j}$ ）。
> 
> **_拓展_**
> 
> TCP 头结构如下图所示：
> 
> ![](https://pic3.zhimg.com/v2-ffa54c821a31be670d54150441f5fd7a_r.jpg)
> 
> HTTP 头结构如下图所示：
> 
> ![](https://picx.zhimg.com/v2-c3c6c3fec33e4c1f8e45e2c9514503d5_r.jpg)
> 
> 根据该以太网数据帧前 80 个字节内容，还可以对其 TCP 头和 HTTP 头进行解析，HTTP 头也可以直接逐个读取每个字节内容获取，依次将每个字节的十六进制表示转换为 ASCII 字符（这里使用的是扩展 ASCII 码，能表示 256 个字符，每个字符占 8 bit），不能直接显示的字符用点替代，结果与最右边以太网数据帧的 ASCII 表示一致。解析结果如下图所示。
> 
> ![](https://pic4.zhimg.com/v2-4c883d957a63e330feb1dd75aefb749b_r.jpg)
> 
> ASCII 码表（扩展 ASCII 码表的前 128 个字符）如下：
> 
> ![](https://pic1.zhimg.com/v2-dc00e910d89cd6d4312444ec7257b5d6_r.jpg)
> 
> **_小技巧_**
> 
> 解析以太网数据帧工作量很大且要求非常细心，有一个可高度置信的小技巧：
> 
> 因为 IP 协议默认采用 [[ipv4]]（理论上不会要求对 IPv6 头进行解析），IP 头部长度默认 20 B（一般情况下上 IP 头的选项字段为空），所以找到以太网数据帧的十六进制表示的内容中的 **45**，即找到了 IP 头的起始位置。